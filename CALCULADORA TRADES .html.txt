import yfinance as yf
from colorama import Fore, Style, init

# Inicializa o colorama para cores no terminal
init(autoreset=True)

class TradeCalculator:
    def __init__(self):
        self.ativo = ""
        self.compra_valor = 0.0
        self.compra_qtd = 0
        self.venda_valor = 0.0
        self.tipo_operacao = "SWING TRADE" # Padr√£o
        self.irrf_aliquota_swing = 0.00005 # 0.005%

    def _obter_dados_empresa(self):
        """Busca informa√ß√µes b√°sicas da empresa usando yfinance."""
        try:
            ticker = yf.Ticker(self.ativo)
            info = ticker.info
            
            # Filtra algumas informa√ß√µes relevantes
            nome_empresa = info.get('longName', 'N√£o Dispon√≠vel')
            setor = info.get('sector', 'N√£o Dispon√≠vel')
            website = info.get('website', 'N√£o Dispon√≠vel')
            preco_atual = info.get('currentPrice', 'N√£o Dispon√≠vel')
            
            print(f"\n--- ‚ÑπÔ∏è Informa√ß√µes da Empresa ({self.ativo}) ---")
            print(f"Nome: {nome_empresa}")
            print(f"Setor: {setor}")
            print(f"Site: {website}")
            print(f"Pre√ßo Atual (Aproximado): R$ {preco_atual}")
            print("---------------------------------------------")
            
        except Exception as e:
            print(f"{Fore.YELLOW}Aviso: N√£o foi poss√≠vel obter informa√ß√µes detalhadas para o ativo {self.ativo}. ({e})")

    def _obter_input_usuario(self):
        """Coleta as entradas do usu√°rio."""
        self.ativo = input("1. Insira o Ticker do Ativo (ex: PETR4.SA, MGLU3.SA): ").upper()
        self.compra_valor = float(input("2. Pre√ßo de COMPRA por papel (R$): "))
        self.compra_qtd = int(input("3. Quantidade de pap√©is comprados: "))
        self.venda_valor = float(input("4. Pre√ßo de VENDA por papel (R$): "))
        
        print("\n5. Tipo de Opera√ß√£o:")
        escolha = input("   (Padr√£o: SWING TRADE) Digite 'D' para DAY TRADE ou pressione ENTER para SWING TRADE: ").upper()
        if escolha == 'D':
            self.tipo_operacao = "DAY TRADE"
        else:
            self.tipo_operacao = "SWING TRADE"

    def _calcular_metrics(self):
        """Executa os c√°lculos financeiros e fiscais."""
        
        # 1. Valores Totais
        valor_total_compra = self.compra_valor * self.compra_qtd
        valor_total_venda = self.venda_valor * self.compra_qtd
        
        # 2. Lucro/Preju√≠zo Bruto
        lucro_bruto_auferido = valor_total_venda - valor_total_compra

        # 3. Impostos (Baseado nas regras fornecidas)
        
        # O IRRF ("Dedo-Duro") √© sempre retido pela corretora na fonte.
        # Swing Trade: 0,005% sobre o valor total vendido (conforme especificado pelo usu√°rio)
        irrf_recolhido_corretora = valor_total_venda * self.irrf_aliquota_swing
        
        ir_devido_total = 0.0
        aliquota_efetiva = 0.0
        
        if lucro_bruto_auferido > 0:
            if self.tipo_operacao == "SWING TRADE":
                aliquota_efetiva = 0.15 # Al√≠quota Swing Trade (15% sobre o lucro)
            elif self.tipo_operacao == "DAY TRADE":
                aliquota_efetiva = 0.20 # Al√≠quota Day Trade (20% sobre o lucro)
            
            # IR Total devido sobre o lucro
            ir_devido_total = lucro_bruto_auferido * aliquota_efetiva
        
        # IR a ser pago via DARF (Diferen√ßa)
        # Se lucro_bruto_auferido < 0, o IR Devido √© zero e o DARF √© zero.
        ir_devido_darf = max(0, ir_devido_total - irrf_recolhido_corretora)

        return {
            "valor_total_compra": valor_total_compra,
            "valor_total_venda": valor_total_venda,
            "lucro_bruto_auferido": lucro_bruto_auferido,
            "ir_devido_total": ir_devido_total,
            "irrf_recolhido_corretora": irrf_recolhido_corretora,
            "ir_devido_darf": ir_devido_darf,
            "aliquota_efetiva": aliquota_efetiva
        }

    def _apresentar_relatorio(self, resultados):
        """Imprime o relat√≥rio final."""
        
        lucro_bruto = resultados['lucro_bruto_auferido']
        
        # Formata√ß√£o de Lucro/Preju√≠zo com cor
        cor_lucro = Fore.GREEN if lucro_bruto >= 0 else Fore.RED
        status_lucro = cor_lucro + f"R$ {lucro_bruto:,.2f}" + Style.RESET_ALL
        
        print("\n" + "="*50)
        print(f"üí∞ RELAT√ìRIO DE TRADE - {self.tipo_operacao}")
        print("="*50)
        
        print(f"ATIVO NEGOCIADO: {self.ativo}")
        print(f"QTD. NEGOCIADA: {self.compra_qtd}")
        print(f"PRE√áO M√âDIO COMPRA: R$ {self.compra_valor:,.2f}")
        print(f"PRE√áO M√âDIO VENDA: R$ {self.venda_valor:,.2f}")
        
        print("-" * 50)
        
        # Se√ß√£o de Valores e Lucro
        print(f"VALOR TOTAL DA COMPRA: R$ {resultados['valor_total_compra']:,.2f}")
        print(f"VALOR TOTAL DA VENDA: R$ {resultados['valor_total_venda']:,.2f}")
        print(f"LUCRO/PREJU√çZO BRUTO: {status_lucro}")
        
        print("-" * 50)
        
        # Se√ß√£o de Impostos
        print(f"TIPO DE OPERA√á√ÉO: {self.tipo_operacao}")
        
        if lucro_bruto > 0:
            print(f"AL√çQUOTA DE IR: {int(resultados['aliquota_efetiva'] * 100)}%")
            print(f"IR DEVIDO TOTAL (Lucro * Al√≠quota): R$ {resultados['ir_devido_total']:,.2f}")
            print(f"IRRF RECOLHIDO NA FONTE (0,005% da Venda): R$ {resultados['irrf_recolhido_corretora']:,.2f}")
            print(f"{Fore.CYAN}IR A PAGAR VIA DARF (Diferen√ßa): R$ {resultados['ir_devido_darf']:,.2f}{Style.RESET_ALL}")
            print(f"    (Aten√ß√£o: Voc√™ deve pagar esta DARF at√© o √∫ltimo dia √∫til do m√™s subsequente.)")
        else:
            print(f"N√£o h√° IR devido, pois n√£o houve lucro ou houve preju√≠zo de R$ {abs(lucro_bruto):,.2f}.")
            print(f"IRRF RECOLHIDO NA FONTE (0,005% da Venda): R$ {resultados['irrf_recolhido_corretora']:,.2f}")
            print(f"IR A PAGAR VIA DARF (Diferen√ßa): R$ 0,00")
            print("    (O preju√≠zo pode ser compensado em lucros futuros.)")
        
        print("="*50)

    def rodar(self):
        """Ponto de entrada da ferramenta."""
        try:
            self._obter_input_usuario()
            
            # Buscar informa√ß√µes do ativo antes de apresentar o relat√≥rio
            self._obter_dados_empresa() 
            
            resultados = self._calcular_metrics()
            self._apresentar_relatorio(resultados)
            
        except ValueError:
            print(f"{Fore.RED}Erro: Por favor, insira valores num√©ricos v√°lidos para pre√ßo e quantidade.{Style.RESET_ALL}")
        except Exception as e:
            print(f"{Fore.RED}Ocorreu um erro inesperado: {e}{Style.RESET_ALL}")

# --- Execu√ß√£o da Ferramenta ---
if __name__ == "__main__":
    app = TradeCalculator()
    app.rodar()