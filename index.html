<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de An√°lise de A√ß√µes | RELAT√ìRIO PROFISSIONAL</title>
    <style>
        /* CSS para Estiliza√ß√£o (DARK MODE PROFISSIONAL) */
        :root {
            --bg-color: #1e1e1e; /* Fundo Escuro */
            --container-bg: #2d2d30; /* Fundo do Container */
            --text-color: #f0f0f0; /* Texto Claro */
            --primary-color: #2980b9; /* Azul (Bot√£o) */
            --secondary-color: #1abc9c; /* Verde Menta (T√≠tulo) */
            --border-color: #444444; /* Borda Escura */
            --table-header-bg: #3c3c3c; /* Fundo do Cabe√ßalho da Tabela */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px;
            background-color: var(--container-bg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }
        h1 {
            color: var(--secondary-color);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 300;
        }
        /* √Årea de Input e Configura√ß√µes */
        .config-area {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #383838;
        }
        .input-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .input-group input[type="text"] {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            width: 120px;
            text-transform: uppercase;
            background-color: #444444;
            color: var(--text-color);
        }
        .options-group {
            display: flex;
            gap: 25px;
            align-items: center;
        }
        .options-group label {
            cursor: pointer;
            user-select: none;
            color: var(--text-color);
        }
        .generate-button {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .generate-button:hover {
            background-color: #3498db;
        }
        /* √Årea de Relat√≥rio */
        #relatorio {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .report-section h2 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
            margin-bottom: 25px;
            font-weight: 500;
        }
        /* Tabela de Indicadores */
        .fundamental-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .fundamental-table th, .fundamental-table td {
            border: 1px solid var(--border-color);
            padding: 14px;
            text-align: left;
        }
        .fundamental-table th {
            background-color: var(--table-header-bg);
            color: var(--text-color);
            font-weight: bold;
        }
        .fundamental-table tr:nth-child(even) {
            background-color: #353538;
        }
        /* Estilos de An√°lise */
        .barata { color: #27ae60; font-weight: bold; } /* Verde - Compra */
        .justa { color: #f39c12; font-weight: bold; } /* Amarelo - Neutro */
        .cara { color: #e74c3c; font-weight: bold; } /* Vermelho - Venda */
        .moderado { color: #7f8c8d; font-weight: bold; }
        .alto { color: #1abc9c; font-weight: bold; }
        .cotacao, .nd, .indefinida { color: var(--text-color); }
    </style>
</head>
<body>

    <div class="container">
        <h1>üìä Sistema de An√°lise de A√ß√µes & Fundamentos</h1>

        <div class="config-area">
            <div class="input-group">
                <label for="ticker">Ticker da A√ß√£o:</label>
                <input type="text" id="ticker" placeholder="Ex: RANI3" maxlength="6">
            </div>

            <div class="options-group">
                <label>
                    <input type="checkbox" id="analiseTecnica" checked>
                    AN√ÅLISE T√âCNICA
                </label>
                <label>
                    <input type="checkbox" id="analiseFundamentalista" checked>
                    AN√ÅLISE FUNDAMENTALISTA
                </label>
            </div>

            <button class="generate-button" onclick="gerarRelatorio()">GERAR RELAT√ìRIO</button>
        </div>

        <div id="relatorio">
            <p id="instrucao">Digite um Ticker e clique em "GERAR RELAT√ìRIO" para iniciar a an√°lise.</p>
        </div>
    </div>

    <script>
        // Fonte de dados mais robusta e estruturada (Yahoo Finance)
        const YAHOO_FINANCE_URL = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=';
        
        // ‚ö†Ô∏è PROXY CORS MAIS EST√ÅVEL: Usamos um servi√ßo p√∫blico para contornar o bloqueio de seguran√ßa do navegador.
        const CORS_PROXY = 'https://api.allorigins.win/get?url='; 

        // Mapeamento de indicadores CRUCIAIS que n√£o est√£o dispon√≠veis em fontes gratuitas/abertas (MOCK com aviso)
        const MOCK_DATA = {
            PEG: { nome: 'PEG Ratio (Mock)', valor: '0.85', analise: 'Barata', descricao: 'Rela√ß√£o entre PL e o Crescimento. ABAIXO DE 1 √â IDEAL.' },
            ROE: { nome: 'ROE (Mock)', valor: '25.3%', analise: 'Alto', descricao: 'Retorno sobre o Patrim√¥nio L√≠quido. Acima de 15% √© considerado excelente.' }
        };

        // Fun√ß√£o auxiliar para determinar a an√°lise de valor do PL (usando regra de 10-20 do v√≠deo)
        function analisarPL(pl) {
            if (pl === null || isNaN(pl) || pl === undefined) return { classe: 'nd', texto: 'N/D' };
            if (pl < 10) return { classe: 'barata', texto: 'Barata' }; 
            if (pl >= 10 && pl <= 20) return { classe: 'justa', texto: 'Justa' };
            return { classe: 'cara', texto: 'Cara' };
        }
        
        function formatarClasse(texto) {
            return texto.toLowerCase().replace(/[\s\/\(\)]/g, '').replace('√≠', 'i');
        }

        // Fun√ß√£o principal chamada pelo bot√£o
        async function gerarRelatorio() {
            const ticker = document.getElementById('ticker').value.toUpperCase().trim();
            const relatorioDiv = document.getElementById('relatorio');
            const tecnicaChecked = document.getElementById('analiseTecnica').checked;

            if (!ticker) {
                alert('Por favor, digite o Ticker da A√ß√£o (Ex: PETR4, BBDC4).');
                return;
            }

            relatorioDiv.innerHTML = `<p>Buscando dados **REAIS** (Pre√ßo e P/L) para **${ticker}** via Proxy. Aguarde...</p>`;

            try {
                // 1. CONSTRU√á√ÉO DA URL COM SUFIXO BRASILEIRO E O NOVO PROXY
                const symbol = `${ticker}.SA`;
                const originalUrl = YAHOO_FINANCE_URL + symbol;
                
                // A API allorigins.win envolve a URL de destino
                const url = `${CORS_PROXY}${encodeURIComponent(originalUrl)}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Erro na requisi√ß√£o (Status: ${response.status}).`);
                }

                // O allorigins.win retorna um JSON, e o JSON original est√° dentro do campo 'contents'
                const proxyData = await response.json();
                
                // Tenta fazer o parse do JSON de conte√∫do
                let data;
                try {
                    data = JSON.parse(proxyData.contents); 
                } catch (e) {
                    throw new Error("Erro ao processar dados do proxy. JSON inv√°lido.");
                }

                const quoteData = data.quoteResponse.result[0];

                if (!quoteData || !quoteData.regularMarketPrice) {
                    relatorioDiv.innerHTML = `<p style="color: #e74c3c;">‚ùå Ticker **${ticker}** n√£o encontrado ou o proxy falhou. Tente **PETR4** ou **BBDC4**.</p>`;
                    return;
                }

                // 2. EXTRA√á√ÉO DE DADOS REAIS
                const plValue = quoteData.trailingPE;
                const dyValue = quoteData.trailingAnnualDividendYield ? (quoteData.trailingAnnualDividendYield * 100).toFixed(2) : 'N/D';
                
                const plAnalise = analisarPL(plValue);
                const dyAnalise = dyValue !== 'N/D' && dyValue > 5 ? 'Alto' : 'Moderado';

                // 3. CONSTR√ìI O ARRAY DE INDICADORES (Reais + Mock com aviso)
                const indicadoresFinais = [
                    {
                        nome: 'Pre√ßo Atual (R$)',
                        descricao: 'Cota√ß√£o de mercado em tempo real.',
                        valor: quoteData.regularMarketPrice.toFixed(2),
                        analise: 'Cota√ß√£o'
                    },
                    {
                        nome: 'P/L (P/E Ratio) REAL',
                        descricao: 'Mede o qu√£o cara ou barata a a√ß√£o est√° em rela√ß√£o ao seu lucro.',
                        valor: plValue !== undefined ? plValue.toFixed(2) + 'x' : 'N/D',
                        analise: plAnalise.texto
                    },
                    {
                        nome: 'Dividend Yield REAL',
                        descricao: 'Retorno em dividendos nos √∫ltimos 12 meses.',
                        valor: dyValue + '%',
                        analise: dyAnalise
                    },
                    MOCK_DATA.PEG,
                    MOCK_DATA.ROE, 
                ];

                // 4. MONTA O HTML DO RELAT√ìRIO
                let htmlContent = `
                    <div class="report-section fundamentalista">
                        <h2>Relat√≥rio de An√°lise Fundamentalista: ${ticker}</h2>
                        <p style="color: #f39c12;">‚ö†Ô∏è **AVISO:** O Pre√ßo, P/L e DY s√£o **REAIS** (via Yahoo Finance). O PEG e ROE s√£o **MOCKADOS** devido √† aus√™ncia de fontes gratuitas e est√°veis.</p>
                        
                        <table class="fundamental-table">
                            <thead>
                                <tr>
                                    <th>Indicador</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor Encontrado</th>
                                    <th>An√°lise de Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Preencher a tabela
                indicadoresFinais.forEach(item => {
                    const classeAnalise = formatarClasse(item.analise);
                    
                    htmlContent += `
                        <tr>
                            <td><strong>${item.nome}</strong></td>
                            <td>${item.descricao}</td>
                            <td>${item.valor}</td>
                            <td class="${classeAnalise}">${item.analise}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        
                        <h3>Conclus√£o Fundamentalista</h3>
                        <p>A√ß√£o **${ticker}** negociada a **R$ ${indicadoresFinais[0].valor}**. Com um P/L de **${indicadoresFinais[1].valor}** (classificado como **${indicadoresFinais[1].analise}**), o ativo tem uma avalia√ß√£o de pre√ßo em rela√ß√£o ao lucro ${indicadoresFinais[1].analise}. A estabilidade do sistema depende da disponibilidade do servi√ßo de proxy CORS.</p>
                    </div>
                `;

                // Adiciona An√°lise T√©cnica (Mockup)
                if (tecnicaChecked) {
                    htmlContent += `
                        <div class="report-section tecnica" style="margin-top: 40px;">
                            <h2>Relat√≥rio de An√°lise T√©cnica: ${ticker}</h2>
                            <p>An√°lise de Pre√ßo e Volume: O ativo est√° em tend√™ncia lateral no curto prazo. **Recomenda√ß√£o:** Tend√™ncia indefinida, sugerindo **Cautela**.</p>
                        </div>
                    `;
                }

                relatorioDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error('Erro de busca na API:', error);
                relatorioDiv.innerHTML = `<p style="color: #e74c3c;">‚ùå Erro na busca de dados reais. Isso pode ser devido ao Ticker incorreto, ou o servi√ßo de **Proxy (CORS)** estar temporariamente indispon√≠vel. Tente novamente mais tarde.</p>`;
            }
        }
    </script>
</body>
</html>
