<script>
    // ⚠️ ATENÇÃO: Seus MOCK_DATA foram removidos para serem substituídos pelo resultado do Python.

    // A nova URL do seu Backend Flask
    const FLASK_API_URL = 'http://127.0.0.1:5000/api/analise';

    // Função auxiliar para determinar a classe CSS (mantida)
    function formatarClasse(texto) {
        return texto.toLowerCase().replace(/[\s\/\(\)]/g, '').replace('í', 'i');
    }

    // Função principal chamada pelo botão
    async function gerarRelatorio() {
        const ticker = document.getElementById('ticker').value.toUpperCase().trim();
        const relatorioDiv = document.getElementById('relatorio');
        const tecnicaChecked = document.getElementById('analiseTecnica').checked;

        if (!ticker) {
            alert('Por favor, digite o Ticker da Ação (Ex: PETR4).');
            return;
        }

        relatorioDiv.innerHTML = `<p>Buscando dados **FUNDAMENTAIS** de **${ticker}** via Web Scraping (Python/Status Invest). Aguarde...</p>`;

        try {
            // 1. CHAMA O BACKEND PYTHON
            const url = `${FLASK_API_URL}?ticker=${ticker}`;
            const response = await fetch(url);

            if (!response.ok) {
                 // Erro HTTP (ex: 404, 500)
                throw new Error(`Erro na comunicação com a API (Status: ${response.status}). Verifique se o app.py está rodando.`);
            }

            const dados = await response.json();

            if (dados.status === 'erro') {
                relatorioDiv.innerHTML = `<p style="color: #e74c3c;">❌ Erro na extração para **${ticker}**: ${dados.mensagem}</p>`;
                return;
            }

            // 2. CONSTRÓI O ARRAY DE INDICADORES COM DADOS REAIS
            const indicadoresFinais = [
                {
                    nome: 'Preço Atual (R$)',
                    descricao: 'Cotação de mercado (Status Invest).',
                    valor: dados.preco_atual,
                    analise: 'Cotação'
                },
                {
                    nome: 'P/L (P/E Ratio) REAL',
                    descricao: 'Mede o quão cara ou barata a ação está em relação ao seu lucro (Status Invest).',
                    valor: dados.pl_valor + 'x',
                    analise: dados.pl_analise
                },
                // ⚠️ Adicione aqui outros indicadores que você extrair no futuro
                { nome: 'Dividend Yield (Mock)', valor: 'N/D%', analise: 'Moderado', descricao: 'Aguardando implementação de scraping' },
                { nome: 'ROE (Mock)', valor: 'N/D%', analise: 'Moderado', descricao: 'Aguardando implementação de scraping' }
            ];

            // 3. MONTA O HTML DO RELATÓRIO (Lógica de montagem similar à sua original)
            let htmlContent = `
                <div class="report-section fundamentalista">
                    <h2>Relatório de Análise Fundamentalista: ${ticker}</h2>
                    <p style="color: #f39c12;">✅ Dados de Preço e P/L obtidos via Web Scraping do Status Invest. Outros dados são MOCKADOS.</p>
                    
                    <table class="fundamental-table">
                        <thead>
                            <tr>
                                <th>Indicador</th>
                                <th>Descrição</th>
                                <th>Valor Encontrado</th>
                                <th>Análise de Valor</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Preencher a tabela
            indicadoresFinais.forEach(item => {
                const classeAnalise = formatarClasse(item.analise);
                
                htmlContent += `
                    <tr>
                        <td><strong>${item.nome}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.valor}</td>
                        <td class="${classeAnalise}">${item.analise}</td>
                    </tr>
                `;
            });

            htmlContent += `
                        </tbody>
                    </table>
                    
                    <h3>Conclusão Fundamentalista</h3>
                    <p>Ação **${ticker}** negociada a **R$ ${dados.preco_atual}**. Com um P/L de **${dados.pl_valor}x** (classificado como **${dados.pl_analise}**), o ativo tem uma avaliação de preço em relação ao lucro ${dados.pl_analise}.</p>
                </div>
            `;

            // Adiciona Análise Técnica (Mockup)
            if (tecnicaChecked) {
                htmlContent += `
                    <div class="report-section tecnica" style="margin-top: 40px;">
                        <h2>Relatório de Análise Técnica: ${ticker}</h2>
                        <p>Análise de Preço e Volume: O ativo está em tendência lateral no curto prazo. **Recomendação:** Tendência indefinida, sugerindo **Cautela**.</p>
                    </div>
                `;
            }

            relatorioDiv.innerHTML = htmlContent;

        } catch (error) {
            console.error('Erro geral:', error);
            relatorioDiv.innerHTML = `<p style="color: #e74c3c;">❌ Falha Crítica. Certifique-se de que o **Servidor Flask (app.py)** está rodando no Terminal e que você está usando o Ticker correto (Ex: PETR4).</p>`;
        }
    }
</script>
