<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Análise de Ações</title>
    <style>
        /* CSS para estilização (Estilos básicos para clareza) */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        /* Área de Input e Configurações */
        .config-area {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
        }
        .input-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        .input-group input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 120px;
            text-transform: uppercase;
        }
        .options-group {
            display: flex;
            gap: 20px;
        }
        .options-group label {
            cursor: pointer;
            user-select: none;
        }
        .generate-button {
            padding: 10px 20px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .generate-button:hover {
            background-color: #3498db;
        }
        /* Área de Relatório */
        #relatorio {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ecf0f1;
        }
        .report-section h2 {
            color: #16a085;
            border-bottom: 2px solid #1abc9c;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        /* Tabela de Indicadores */
        .fundamental-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .fundamental-table th, .fundamental-table td {
            border: 1px solid #dddddd;
            padding: 12px;
            text-align: left;
        }
        .fundamental-table th {
            background-color: #ecf0f1;
            color: #34495e;
            font-weight: bold;
        }
        .fundamental-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* Estilos de Análise (A ser preenchido pelo JS) */
        .barata { color: #27ae60; font-weight: bold; }
        .justa { color: #f39c12; font-weight: bold; }
        .cara { color: #c0392b; font-weight: bold; }
        .moderado { color: #008cba; font-weight: bold; }
        .alto { color: #008000; font-weight: bold; }
        .cotacao { color: #2c3e50; }
        .indefinida { color: #7f8c8d; }

    </style>
</head>
<body>

    <div class="container">
        <h1>Análise de Ações</h1>

        <div class="config-area">
            <div class="input-group">
                <label for="ticker">Ticker da Ação:</label>
                <input type="text" id="ticker" placeholder="Ex: PETR4" maxlength="6">
            </div>

            <div class="options-group">
                <label>
                    <input type="checkbox" id="analiseTecnica" checked>
                    ANÁLISE TÉCNICA
                </label>
                <label>
                    <input type="checkbox" id="analiseFundamentalista" checked>
                    ANÁLISE FUNDAMENTALISTA
                </label>
            </div>

            <button class="generate-button" onclick="gerarRelatorio()">GERAR RELATÓRIO</button>
        </div>

        <div id="relatorio">
            <p id="instrucao">Digite um Ticker e clique em "GERAR RELATÓRIO" para iniciar a análise.</p>
        </div>
    </div>

    <script>
        // ⚠️ SEU TOKEN DA BRAPI:
        const API_TOKEN = 'x6NYckniQmXHAC5b4prLET'; 
        const BASE_URL = 'https://brapi.dev/api/quote/';

        // Mapeamento de indicadores que o brapi gratuito não fornece, mas é bom para a análise (MOCK)
        const MOCK_INDICATORS = {
            PEG: { nome: 'PEG Ratio (Mock)', valor: '0.85', analise: 'Barata', descricao: 'Relação entre PL e o Crescimento do Lucro. Abaixo de 1 é considerado barato.' }
        };

        // Função auxiliar para determinar a análise de valor do PL
        function analisarPL(pl) {
            if (pl === null || isNaN(pl)) return { classe: 'indefinida', texto: 'N/D' };
            // Usando o high de 52 semanas como substituto, pois o PL não é garantido no plano gratuito
            // O ideal seria pegar o PL real e usar: if (pl < 10) return...
            if (pl < 25) return { classe: 'barata', texto: 'Barata' };
            if (pl >= 25 && pl <= 35) return { classe: 'justa', texto: 'Justa' };
            return { classe: 'cara', texto: 'Cara' };
        }
        
        // Função auxiliar para formatar a classe CSS
        function formatarClasse(texto) {
            return texto.toLowerCase().replace(' ', '').replace('/', '');
        }

        // Função principal chamada pelo botão
        async function gerarRelatorio() {
            const tickerInput = document.getElementById('ticker');
            const ticker = tickerInput.value.toUpperCase().trim();
            const relatorioDiv = document.getElementById('relatorio');
            const tecnicaChecked = document.getElementById('analiseTecnica').checked;

            if (!ticker) {
                alert('Por favor, digite o Ticker da Ação (Ex: PETR4, BBDC4).');
                return;
            }

            relatorioDiv.innerHTML = `<p>Buscando dados para **${ticker}**. Aguarde...</p>`;

            try {
                // 1. CHAMA A API BRAPI para obter dados da cotação
                // O parâmetro modules=defaultKeyStatistics,summaryDetail tenta trazer mais dados, mas o PL real é limitado no plano gratuito
                const url = `${BASE_URL}${ticker}?token=${API_TOKEN}&modules=defaultKeyStatistics,summaryDetail`;
                const response = await fetch(url);

                if (!response.ok) {
                    relatorioDiv.innerHTML = `<p style="color: red;">❌ Erro ao buscar dados para **${ticker}**. Verifique o Ticker ou o Token.</p>`;
                    return;
                }

                const data = await response.json();
                const stockData = data.results[0];

                if (!stockData || !stockData.regularMarketPrice) {
                    relatorioDiv.innerHTML = `<p style="color: red;">❌ Ticker **${ticker}** não encontrado ou sem dados fundamentalistas disponíveis na API.</p>`;
                    return;
                }

                // Usando o high de 52 semanas como substituto para um indicador de "precificação"
                const plValue = stockData.fiftyTwoWeekHigh; 
                // Usando o Dividend Yield (DY) real, pois ele geralmente está disponível
                const dyValue = stockData.dividendYield ? (stockData.dividendYield * 100).toFixed(2) : 'N/D';
                
                const plAnalise = analisarPL(plValue);
                const dyAnalise = dyValue > 5 ? 'Alto' : 'Moderado'; // Simplesmente se for maior que 5%

                // 2. CONSTRÓI O ARRAY DE INDICADORES DINÂMICOS
                const indicadoresReais = [
                    {
                        nome: 'Preço Atual (R$)',
                        descricao: 'Cotação atual do ativo no mercado.',
                        valor: stockData.regularMarketPrice.toFixed(2),
                        analise: 'Cotação'
                    },
                    {
                        nome: 'PL (Simulado)',
                        descricao: 'Valor máximo em 52 semanas. (PL real indisponível no plano gratuito).',
                        valor: plValue ? plValue.toFixed(2) + 'x' : 'N/D',
                        analise: plAnalise.texto
                    },
                    {
                        nome: 'Dividend Yield',
                        descricao: 'Retorno em dividendos nos últimos 12 meses.',
                        valor: dyValue + '%',
                        analise: dyAnalise
                    },
                    MOCK_INDICATORS.PEG, // Mantém o PEG mockado
                    {
                        nome: 'ROE (Simulado)',
                        descricao: 'Retorno sobre o Patrimônio Líquido. (Valor simulado para exemplo).',
                        valor: '25.3%',
                        analise: 'Alto' 
                    },
                ];

                // 3. MONTA O HTML DO RELATÓRIO
                let htmlContent = `
                    <div class="report-section fundamentalista">
                        <h2>Relatório de Análise Fundamentalista: ${ticker}</h2>
                        <p>Dados obtidos via API (brapi - Gratuito). Indicadores como P/L e ROE real podem exigir um plano pago da API.</p>
                        
                        <table class="fundamental-table">
                            <thead>
                                <tr>
                                    <th>Indicador</th>
                                    <th>Descrição</th>
                                    <th>Valor Encontrado</th>
                                    <th>Análise de Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // Preencher a tabela
                indicadoresReais.forEach(item => {
                    const classeAnalise = formatarClasse(item.analise);
                    
                    htmlContent += `
                        <tr>
                            <td><strong>${item.nome}</strong></td>
                            <td>${item.descricao}</td>
                            <td>${item.valor}</td>
                            <td class="${classeAnalise}">${item.analise}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        
                        <h3>Tomada de Decisão (Conclusão Resumida)</h3>
                        <p>A ação **${ticker}** está sendo negociada a **R$ ${indicadoresReais[0].valor}**. Apresenta um **Dividend Yield de ${indicadoresReais[2].valor} (${dyAnalise})**, sendo um bom pagador de proventos. Embora o P/L e o ROE sejam simulados, o **PEG Ratio (0.85 - Barata)** no modelo sugere um potencial de crescimento subvalorizado. Esta análise serve como um ponto de partida para sua pesquisa.</p>
                    </div>
                `;

                // Adiciona Análise Técnica (Mockup)
                if (tecnicaChecked) {
                    htmlContent += `
                        <div class="report-section tecnica" style="margin-top: 40px;">
                            <h2>Relatório de Análise Técnica: ${ticker}</h2>
                            <p>A análise técnica aponta o preço atual (R$ ${indicadoresReais[0].valor}) em relação às médias móveis e volumes. **Recomendação:** No momento, o ativo exibe tendência lateral de curto prazo, sugerindo **Neutralidade** para *trades* rápidos. 

[Image of Technical Analysis chart]

                        </div>
                    `;
                }

                relatorioDiv.innerHTML = htmlContent;

            } catch (error) {
                console.error('Erro geral ao processar o relatório:', error);
                relatorioDiv.innerHTML = `<p style="color: red;">❌ Houve um erro inesperado na requisição (Verifique se o Ticker está correto ou se a brapi está online).</p>`;
            }
        }
    </script>
</body>
</html>
