<script>
    // URL para busca no Google Finance (sem proxy, mais direto)
    const GOOGLE_FINANCE_URL = 'https://www.google.com/finance/quote/';

    // Mapeamento de indicadores CRUCIAIS que não estão disponíveis em fontes gratuitas/abertas (MOCK com aviso)
    const MOCK_DATA = {
        PEG: { nome: 'PEG Ratio (Mock)', valor: '0.85', analise: 'Barata', descricao: 'Relação entre PL e o Crescimento. ABAIXO DE 1 É IDEAL.' },
        ROE: { nome: 'ROE (Mock)', valor: '25.3%', analise: 'Alto', descricao: 'Retorno sobre o Patrimônio Líquido. Acima de 15% é considerado excelente.' }
    };

    // Função auxiliar para determinar a análise de valor do PL (usando regra de 10-20 do vídeo)
    function analisarPL(pl) {
        if (pl === null || isNaN(pl) || pl === undefined) return { classe: 'nd', texto: 'N/D' };
        if (pl < 10) return { classe: 'barata', texto: 'Barata' }; 
        if (pl >= 10 && pl <= 20) return { classe: 'justa', texto: 'Justa' };
        return { classe: 'cara', texto: 'Cara' };
    }
    
    function formatarClasse(texto) {
        return texto.toLowerCase().replace(/[\s\/\(\)]/g, '').replace('í', 'i');
    }

    // Função principal chamada pelo botão
    async function gerarRelatorio() {
        const ticker = document.getElementById('ticker').value.toUpperCase().trim();
        const relatorioDiv = document.getElementById('relatorio');
        const tecnicaChecked = document.getElementById('analiseTecnica').checked;

        if (!ticker) {
            alert('Por favor, digite o Ticker da Ação (Ex: PETR4, BBDC4).');
            return;
        }

        relatorioDiv.innerHTML = `<p>Buscando dados **REAIS** (Google Finance) para **${ticker}**. Aguarde...</p>`;

        try {
            // 1. CHAMA O GOOGLE FINANCE
            // Este método é propenso a falhas de CORS, mas é o mais direto sem proxy ou backend.
            const symbol = `BVMF%3A${ticker}`; // Formato do Google Finance para B3
            const url = GOOGLE_FINANCE_URL + symbol;
            
            // Usando uma API pública temporária que tenta buscar HTML e extrair dados
            // Isso é um último recurso para evitar o CORS
            const publicApi = `https://cors-proxy.fintz.workers.dev/api/data?url=${encodeURIComponent(url)}`;
            
            const response = await fetch(publicApi);

            if (!response.ok) {
                throw new Error(`Erro na requisição (Status: ${response.status}).`);
            }

            const data = await response.json();
            const htmlContent = data.data;

            // Tentativa de extrair dados do HTML (Web Scraping Básico em JS Puro)
            // ESTE MÉTODO É EXTREMAMENTE FRÁGIL E QUEBRA FACILMENTE
            
            // Extrai o Preço
            const priceMatch = htmlContent.match(/<div class="YMlKec fxKbKc">(.+?)<\/div>/);
            const priceText = priceMatch ? priceMatch[1].replace('R$', '').trim().replace('.', '').replace(',', '.') : 'N/D';
            const priceValue = parseFloat(priceText);
            
            // Extrai o P/L (P/E Ratio)
            const peMatch = htmlContent.match(/P\/L<\/div><div class="P6K7Qc">(.+?)<\/div>/);
            const peText = peMatch ? peMatch[1].trim().replace(',', '.') : 'N/D';
            const plValue = parseFloat(peText);

            // Mockando o DY, pois extraí-lo confiavelmente do Google Finance é muito complexo
            const dyValue = '4.50'; 

            if (isNaN(priceValue)) {
                relatorioDiv.innerHTML = `<p style="color: #e74c3c;">❌ Ticker **${ticker}** não encontrado ou o formato do site mudou. (Tente **PETR4** ou **BBDC4**).</p>`;
                return;
            }

            // 2. ANÁLISE DOS DADOS REAIS
            const plAnalise = analisarPL(plValue);
            const dyAnalise = dyValue !== 'N/D' && dyValue > 5 ? 'Alto' : 'Moderado';

            // 3. CONSTRÓI O ARRAY DE INDICADORES
            const indicadoresFinais = [
                {
                    nome: 'Preço Atual (R$)',
                    descricao: 'Cotação de mercado no momento da busca.',
                    valor: priceValue.toFixed(2),
                    analise: 'Cotação'
                },
                {
                    nome: 'P/L (P/E Ratio) REAL',
                    descricao: 'Mede o quão cara ou barata a ação está em relação ao seu lucro.',
                    valor: plValue !== undefined && !isNaN(plValue) ? plValue.toFixed(2) + 'x' : 'N/D',
                    analise: plAnalise.texto
                },
                {
                    nome: 'Dividend Yield (Mock)',
                    descricao: 'Retorno em dividendos nos últimos 12 meses.',
                    valor: dyValue + '%',
                    analise: dyAnalise
                },
                MOCK_DATA.PEG,
                MOCK_DATA.ROE, 
            ];

            // 4. MONTA O HTML DO RELATÓRIO (mantendo o estilo Dark Mode)
            let htmlContent = `
                <div class="report-section fundamentalista">
                    <h2>Relatório de Análise Fundamentalista: ${ticker}</h2>
                    <p style="color: #f39c12;">⚠️ **AVISO:** O P/L e o Preço são **REAIS** (extraídos do Google Finance), mas a extração é frágil. O PEG, ROE e DY são **MOCKADOS**.</p>
                    
                    <table class="fundamental-table">
                        <thead>
                            <tr>
                                <th>Indicador</th>
                                <th>Descrição</th>
                                <th>Valor Encontrado</th>
                                <th>Análise de Valor</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Preencher a tabela
            indicadoresFinais.forEach(item => {
                const classeAnalise = formatarClasse(item.analise);
                
                htmlContent += `
                    <tr>
                        <td><strong>${item.nome}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.valor}</td>
                        <td class="${classeAnalise}">${item.analise}</td>
                    </tr>
                `;
            });

            htmlContent += `
                        </tbody>
                    </table>
                    
                    <h3>Conclusão Fundamentalista</h3>
                    <p>Ação **${ticker}** negociada a **R$ ${indicadoresFinais[0].valor}**. O P/L de **${indicadoresFinais[1].valor}** indica uma avaliação **${indicadoresFinais[1].analise}**. A análise completa requer a validação de todos os indicadores em fontes robustas.</p>
                </div>
            `;

            // Adiciona Análise Técnica (Mockup)
            if (tecnicaChecked) {
                htmlContent += `
                    <div class="report-section tecnica" style="margin-top: 40px;">
                        <h2>Relatório de Análise Técnica: ${ticker}</h2>
                        <p>Análise de Preço e Volume: O ativo está em tendência lateral no curto prazo. **Recomendação:** Tendência indefinida, sugerindo **Cautela**.</p>
                    </div>
                `;
            }

            relatorioDiv.innerHTML = htmlContent;

        } catch (error) {
            console.error('Erro de busca na API:', error);
            relatorioDiv.innerHTML = `<p style="color: #e74c3c;">❌ Falha Crítica: Não foi possível buscar dados. O web scraping é instável (Formato do site mudou), ou o serviço de proxy falhou. </p>`;
        }
    }
</script>
